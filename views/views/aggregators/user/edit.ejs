<section class="productsdetail">
	<div class="container">
		<div class="breadcrumb_card">
			<%- include('../../shared/breadcrumb') %>
		</div>
		<div class="product_card">
			<div class="help_sidebar_right">
				<form id="frm-edit-user" action="" method="post" enctype="multipart/form-data">
					<input type="hidden" value="<%= farmer.farmer_id %>" id="farmer_id" name="farmer_id">
					<div class="row order-list-title">
						<div class="col-md-12 col-sm-12 col-xs-12">
							<h3>
								<%= labels['EDIT_FARMER'][language] %>
							</h3>
						</div>
						<div class="row">
							<div class="col-md-3 col-sm-12 col-xs-12">
								<div class="search-container">
									<label class="my-1 mr-2">
										<%= labels['LBL_SIGN_UP_FIRST_NAME'][language] %>
									</label>
									<input type="text" id="txt-firstname" name="first_name"
										value="<%= farmer.first_name %>" class="form-control" placeholder=""
										required="">
									<span class="validation-alert" id='err-firstname'></span>
								</div>
							</div>
							<div class="col-md-3 col-sm-12 col-xs-12">
								<div class="search-container">
									<label class="my-1 mr-2">
										<%= labels['LBL_SIGN_UP_LAST_NAME'][language] %>
									</label>
									<input class="custom_input" type="text" placeholder=""
										value="<%= farmer.last_name %>" id='txt-lastname' name="last_name">
									<span class="validation-alert" id='err-lastname'></span>
								</div>
							</div>
							<div class="col-md-6 col-sm-12 col-xs-12">
								<div class="search-container">
									<label class="my-1 mr-2">
										<%= labels['LBL_EMAIL'][language] %>
									</label>
									<input class="custom_input txt-disabled" type="text" placeholder=""
										value="<%= farmer.email %>" id='email' name="email" disabled>
									<span class="validation-alert" id='err-email'></span>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-3 col-sm-12 col-xs-12">
								<div class="search-container">
									<label class="my-1 mr-2">
										<%= labels['LBL_FARMER_USER_MOBILE_COUNTRY_CODE'][language] %>
									</label>
									<select class="form-control mobile_country_code" id="mobile_country_code"
										name="mobile_country_code" style='height:42px;cursor:pointer;'>
										<option value="">--- <%=
												labels['LBL_FARMER_USER_MOBILE_COUNTRY_CODE_PLACEHOLDER'][language] %>
												---</option>
									</select>
								</div>
							</div>
							<div class="col-md-3 col-sm-12 col-xs-12">
								<div class="search-container">
									<label class="my-1 mr-2">
										<%= labels['LBL_FARMER_USER_MOBILE_NUMBER'][language] %>
									</label>
									<input class="custom_input" type="text" placeholder="" id='phone_number'
										name="phone_number" value="<%= farmer.phone_number %>">
								</div>
							</div>

							<div class="col-md-6 col-sm-12 col-xs-12">
								<div class="search-container">
									<label class="my-1 mr-2">
										<%= labels['LBL_ADDRESS'][language] %>
									</label>
									<input class="custom_input" type="text" placeholder="" value="<%= farmer.address %>"
										id='address' name="address">
									<span class="validation-alert" id='err-address'></span>
								</div>
							</div>


						</div>
						<div class="row">
							<div class="col-md-6 col-sm-12 col-xs-12">
								<div class="search-container">
									<label class="my-1 mr-2">
										<%= labels['LBL_FARMER_USER_BANK_NAME'][language] %>
									</label>
									<select class="custom_input form-control bank_data_html " id="bank_name" name="bank_name"
										style='height:42px;cursor:pointer;'>
										
									</select>

									<span class="validation-alert" id='err-bank-name'></span>
								</div>
							</div>

							<div class="col-md-6 col-sm-12 col-xs-12">
								<div class="search-container">
									<label class="my-1 mr-2">
										<%= labels['LBL_FARMER_USER_BANK_ACCOUNT_NO'][language] %>
									</label>
									<input class="custom_input farmer_bank_account_no_edit" type="text" placeholder=""
										id='bank_account_no' name="bank_account_no"
										value="<%= farmer.bank_account_no %>">
									<span class="validation-alert" id='err-bank-account-no'></span>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-3 col-sm-12 col-xs-12">
								<div class="search-container">
									<label class="my-1 mr-2">
										<%= labels['LBL_FARMER_LOGIN_SECURITY_NIF'][language] %>
									</label>
									<input class="custom_input farmer_nif_number" type="text" placeholder="" id='nif'
										name="nif" value="<%= farmer.nif %>">
									<span class="validation-alert" id='err-nif'></span>
								</div>
							</div>

							<div class="col-md-3 col-sm-12 col-xs-12" id="section_state_id">
								<div class="search-container">
									<label class="my-1 mr-2">
										<%= labels['LBL_STATE'][language] %>
									</label>
									<select class="select_plug state_id" id="state_id" name="state_id"
										onchange="getCities('<%=baseURL%>')">
										<option value="">--- <%= labels['LBL_SELECT_STATE'][language] %> ---</option>
									</select>
									<span class="validation-alert" id='err-state-id'></span>
								</div>
							</div>

							<div class="col-md-6 col-sm-12 col-xs-12" id="section_city_id">
								<div class="search-container">
									<label class="my-1 mr-2">
										<%= labels['LBL_CITY'][language] %>
									</label>
									<select class="select_plug city_id" id="city_id" name="city_id">
										<option value="">--- <%= labels['LBL_SELECT_CITY'][language] %> ---</option>
									</select>
									<span class="validation-alert" id='err-city-id'></span>
								</div>
							</div>

						</div>
						<div class="row">
							<div class="col-md-6 col-sm-12 col-xs-12" id="section_images">
								<div class="search-container">
									<label class="my-1 mr-2">
										<%= labels['LBL_PROFILE_PICTURE'][language] %>
									</label>
									<div class="input-group">
										<div class="custom-file">
											<input type="file" class="custom-file-input" id="inputGroupFile01"
												aria-describedby="inputGroupFileAddon01" name="images" id="images">
											<label class="custom-file-label" for="inputGroupFile01"></label>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="row">
							<% if(farmer.photo) { %>
								<div class="col-md-12 col-sm-12 col-xs-12" id="profile_photo_section">
									<div class="col-md-3 col-sm-12 col-xs-12" id="section_location">
										<button type="button" class="close_noti close" aria-label="Close"
											onclick="removeProfileImage('<%= farmer.photo %>')"><span
												aria-hidden="true">×</span></button>
										<img class="pro-img-list" src="<%= farmer.photo %>">
									</div>
								</div>
								<% } %>
						</div>
						<div class="row">
							<div class="col-md-12 col-sm-12 col-xs-12">
								<a href="javascript:void(0)"><button class="main_btn post-add-now" type='button'
										onclick="submitPost()">
										<%= labels['LBL_SAVE_CHANGES'][language] %>
									</button></a>
								<div class="lds-facebook" style="display:none">
									<div></div>
									<div></div>
									<div></div>
								</div>
							</div>
						</div>
					</div>
			</div>
		</div>
	</div>
	</div>
</section>
<script>
	function removeProfileImage(file) {
		$.ajax({
			url: "<%=baseURL%>remove-profile-image?file=" + file + "&farmer_id=" + $('#farmer_id').val(), success: function (result) {
				console.log(result);
				if (result.code == 200) {
					$('#profile_photo_section').remove();
				}

				showAlert(result.message, '<%=baseURL%>', "<%= labels['LBL_MESSAGE'][language] %>");
				setTimeout(() => {
					hideAlert()
				}, 3000);
			}
		});
	}

	function validatePost() {
		let errFirstNameFlag = 0, errLastNameFlag = 0, errEmailFlag = 0, errBankNameFlag = 0, errBankNoFlag = 0, errNIFFlag = 0, errAddressFlag = 0, errStateFlag = 0, errCityFlag = 0;

		if (!$('#txt-firstname').val()) {
			errFirstNameFlag = 1;
			$('#err-firstname').text("<%= labels['LBL_SIGN_UP_VALIDATE_FIRST_NAME'][language] %>").show();
		} else {
			errFirstNameFlag = 0;
			$('#err-firstname').hide();
		}

		if (!$('#txt-lastname').val()) {
			errLastNameFlag = 1;
			$('#err-lastname').text("<%= labels['LBL_SIGN_UP_VALIDATE_LAST_NAME'][language] %>").show();
		} else {
			errLastNameFlag = 0;
			$('#err-lastname').hide();
		}

		errEmailFlag = validateEmailAddress($('#email').val());
		if (errEmailFlag > 0) {
			caption = (errEmailFlag == 1) ? "<%= labels['LBL_ENTER_EMAIL'][language] %>" : "<%= labels['LBL_ENTER_CORRECT_EMAIL'][language] %>";
			$('#err-email').text(caption).show();
		} else {
			$('#err-email').hide();
		}

		if (!$('#bank_name').val()) {
			errBankNameFlag = 1;
			$('#err-bank-name').text("<%= labels['LBL_FARMER_LOGIN_SECURITY_VALIDATE_BANK_NAME'][language] %>").show();
		} else {
			errBankNameFlag = 0;
			$('#err-bank-name').hide();
		}


		let bankAccountNo = $('#bank_account_no').val().replace(/ /g, "");
		errBankNoFlag = validateBankAccountNo(bankAccountNo);
		if (errBankNoFlag) {
			$('#err-bank-account-no').text("<%= labels['LBL_FARMER_LOGIN_SECURITY_VALIDATE_BANK_ACCOUNT_NO'][language] %>").show();
		} else {
			$('#err-bank-account-no').hide();
		}

		if (!$('#nif').val()) {
			errNIFFlag = 1;
			$('#err-nif').text("<%= labels['LBL_FARMER_LOGIN_SECURITY_VALIDATE_NIF'][language] %>").show();
		} else {
			errNIFFlag = 0;
			$('#err-nif').hide();
		}

		if (!$('#address').val()) {
			errAddressFlag = 1;
			$('#err-address').text("<%= labels['LBL_ENTER_ADDRESS'][language] %>").show();
		} else {
			errAddressFlag = 0;
			$('#err-address').hide();
		}

		if (!$('#state_id').val()) {
			errStateFlag = 1;
			$('#err-state-id').text("<%= labels['LBL_ENTER_STATE_VALIDATION'][language] %>").show();
		} else {
			errStateFlag = 0;
			$('#err-state-id').hide();
		}

		if (!$('#city_id').val()) {
			errCityFlag = 1;
			$('#err-city-id').text("<%= labels['LBL_ENTER_CITY_VALIDATION'][language] %>").show();
		} else {
			errCityFlag = 0;
			$('#err-city-id').hide();
		}

		if (!errFirstNameFlag && !errLastNameFlag && !errEmailFlag && !errBankNameFlag && !errBankNoFlag && !errNIFFlag && !errAddressFlag && !errStateFlag && !errCityFlag) {
			return true;
		} else {
			return false;
		}
	}

	function submitPost() {
		if (validatePost()) {
			$(".post-add-now").attr("disabled", true);
			$(".lds-facebook").show();
			if ($('#mobile_country_code').val() && $('#phone_number').val()) {
				$.post('<%=baseURL%>check_farmer_email_exist', { type: 'other', farmer_id: $('#farmer_id').val(), mobile_country_code: $('#mobile_country_code').val(), phone_number: $('#phone_number').val() }).done((result) => {
					if (result.code == 200) {
						//$('#frm-edit-user').submit();
						editarProduto();
					} else {
						$(".post-add-now").attr("disabled", false);
						$(".lds-facebook").hide();
						showAlert(result.message, '<%=baseURL%>', "<%= labels['LBL_MESSAGE'][language] %>");
						setTimeout(() => {
							hideAlert()
						}, 3000);
					}
				});
			} else {
				editarProduto();
				//$('#frm-edit-user').submit();
			}
		}
	}

	function editarProduto() {
		var url = '<%=baseURL%>aggregators/user/edit';
		$.ajax({
			url: url,
			type: "POST",
			data: $('#frm-edit-user').serialize(),
			dataType: "JSON",
			success: function (data) {
				showAlert("Produtor #" + data.farmer_id + " actualizado com sucesso!");
				setTimeout(() => {
					hideAlert()
					window.location.href = "<%=baseURL%>aggregators/user/list"
				}, 3000);
			},
			error: function (jqXHR, textStatus, errorThrown) {
				showAlert("Erro ao actualizar o produtor!");
				setTimeout(() => {
					hideAlert()
					window.location.href = "<%=baseURL%>aggregators/user/list"
				}, 3000);
			}
		});
	}

	var bankList = [
		{
			name: 'Banco de Poupança e Crédito, S.A',
			abbr: 'BPC',
			code: '0006'
		},
		{
			name: 'Banco Sol, S.A.',
			abbr: 'SOL',
			code: '0006'
		},
		{
			name: 'Standard Bank Angola, S.A',
			abbr: 'SBA',
			code: '0006'
		},
		{
			name: 'Banco de Desenvolvimento de Angola, S.A',
			abbr: 'BDA',
			code: '0006'
		},
		{
			name: 'Banco Angolano de Investimentos, S.A',
			abbr: 'BAI',
			code: '0006'
		},
		{
			name: 'Banco BIC, S.A',
			abbr: 'BIC',
			code: '0006'
		},
		{
			name: 'Banco Be Investimento Rural',
			abbr: 'BIR',
			code: '0006'
		},
		{
			name: 'Banco Yetu',
			abbr: 'YETU',
			code: '0006'
		},
		{
			name: 'Standard Chartered Banck Angola',
			abbr: 'STANDARD CHARTERED BANK ANGOLA',
			code: '0006'
		},
		{
			name: 'Banco Da China Limitada - Sucursal em Luanda',
			abbr: 'BOCLB',
			code: '0006'
		},
		{
			name: 'Banco Comercial Do Huambo',
			abbr: 'BCH',
			code: '0006'
		},
		{
			name: 'Banco Kwanza Investimento',
			abbr: 'BKI',
			code: '0006'
		},
		{
			name: 'Banco Valor, S.A',
			abbr: 'BVB',
			code: '0006'
		},
		{
			name: 'Finibanco Angola',
			abbr: 'FNB',
			code: '0006'
		},
		{
			name: 'Credisul - Banco de crédito do sul, S.A',
			abbr: 'BCS',
			code: '0006'
		},
		{
			name: 'Banco Prestígio, S.A',
			abbr: 'BPG',
			code: '0006'
		},
		{
			name: 'VTB ÁFrica, S.A',
			abbr: 'VTB',
			code: '0006'
		},
		{
			name: 'Banco BAI Microfinanças',
			abbr: 'BMF',
			code: '0006'
		},
		{
			name: 'Banco Comercial Angolano, S.A',
			abbr: 'BCA',
			code: '0006'
		},
		{
			name: 'BANCO MILLENIUM ATLÂNTICO, S.A',
			name: 'Banco Millenium Atlântico, S.A',
			abbr: 'ATL',
			code: '0006'
		},
		{
			name: 'Banco Caixa Angola, S.A',
			abbr: 'BCGA',
			code: '0006'
		},
	]

	var options = "<option value=''>-- <%= labels['LBL_PRODUCER_USER_SELECT_BANK_NAME'][language] %> --</option>"

	bankList.forEach((item, index) => {
		options += '<option  data-code="' + item.code + '" value="' + item.abbr + '">' + item.name + '</option>'
	})

	$('.bank_data_html').html(options)


	$(document).ready(function () {
		getStates('<%=baseURL%>', '<%= farmer.state_id %>');
		getCities('<%=baseURL%>', '<%= farmer.city_id %>', '<%= farmer.state_id %>');
		getMobileCountryCodes('<%=baseURL%>', '<%= farmer.mobile_country_code %>');
	})
</script>